<!DOCTYPE html>
<html lang = "en">
   <head>
        <meta charset = "UTF-8">
        <title>test</title>
        <style>
         .chart { width: 450px; max-width: 100%; height: auto; overflow: visible; }
         .chart .u-line { stroke: #aaa; stroke-dasharray: 2 2; }
         .chart .u-path { stroke: orange; fill: none; }
         .chart .u-point circle { fill: orange; }
         .chart { text-anchor: middle; font: 11px var(--sans-serif); user-select:none; }
        </style>
        <script src = "https://d3js.org/d3.v4.min.js"></script>
   </head>

   <body>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.js"></script>
      <script>
         d3.select("body").append("span").text("Hello, world!");

         d3 = require("d3-array@2", "d3-drag@1", "d3-path@1", "d3-selection@1")
         start();

   function start() {
		const path = d3.path(),
		  x0 = 40,
		  y0 = 100,
		  cpx1 = 150,
		  cpy1 = 280,
		  cpx2 = 150,
		  cpy2 = 30,
		  x = 350,
		  y = 50;
	  
		path.moveTo(x0, y0);
		path.bezierCurveTo(cpx1, cpy1, cpx2, cpy2, x, y);
	  
		const chart = svg`<svg viewBox="0 0 450 300" class="chart">
		 <path class="u-path" d="${path}" />
		</svg>`;
	  
		// return chart;
	  
		/**
		 *  Add control elements and prepare interactions
		 */
	  
		const points = [[x0, y0], [cpx1, cpy1], [cpx2, cpy2], [x, y]],
		  labels = ["Start", "Control1", "Control2", "End"],
		  lines = [[points[0], points[1]], [points[2], points[3]]],
		  draw = () => {
			const path = d3.path();
			path.moveTo(...points[0]);
			path.bezierCurveTo(...points[1], ...points[2], ...points[3]);
			return path;
		  };
	  
		draggable(chart, points, labels, lines, draw);
	  
		return chart;
      }  

	/**
	 * function to update arc/curve from https://observablehq.com/@d3/d3-path
	 * @param {*} chart : svg object ?
	 * @param {*} points 
	 * @param {*} labels : labels to appear
	 * @param {*} lines 
	 * @param {*} draw 
	 */
	function update(chart, points, labels, lines, draw) {
		d3.select(chart)
		  .select(".u-path")
		  .attr("d", draw());
	  
		d3.select(chart)
		  .selectAll(".u-point")
		  .data(points)
		  .join(enter =>
			enter
			  .append("g")
			  .classed("u-point", true)
			  .call(g => {
				g.append("circle").attr("r", 3);
				g.append("text")
				  .text((d, i) => labels[i])
				  .attr("dy", d => (d[1] > 100 ? 15 : -5));
			  })
		  )
		  .attr("transform", d => `translate(${d})`);
	  
		d3.select(chart)
		  .selectAll(".u-line")
		  .data(lines)
		  .join("line")
		  .attr("x1", d => d[0][0])
		  .attr("y1", d => d[0][1])
		  .attr("x2", d => d[1][0])
		  .attr("y2", d => d[1][1])
		  .classed("u-line", true);
	  }

	/**
	 * function to simulate drag from https://observablehq.com/@d3/d3-path
	 * @param {*} chart 
	 * @param {*} points 
	 * @param {*} labels 
	 * @param {*} lines 
	 * @param {*} draw 
	 */
	function draggable(chart, points, labels, lines, draw) {
		update(chart, points, labels, lines, draw);
	  
		const dist = p => {
		  const m = d3.mouse(chart);
		  return Math.sqrt((p[0] - m[0]) ** 2 + (p[1] - m[1]) ** 2);
		};
	  
		var subject, dx, dy;
	  
		function dragSubject() {
		  subject = d3.least(points, (a, b) => dist(a) - dist(b));
		  if (dist(subject) > 48) subject = null;
		  if (subject)
			d3.select(chart)
			  .style("cursor", "hand")
			  .style("cursor", "grab");
		  else d3.select(chart).style("cursor", null);
		  return subject;
		}
	  
		d3.select(chart)
		  .on("mousemove", dragSubject)
		  .call(
			d3
			  .drag()
			  .subject(dragSubject)
			  .on("start", () => {
				if (subject) {
				  d3.select(chart).style("cursor", "grabbing");
				  dx = subject[0] - d3.event.x;
				  dy = subject[1] - d3.event.y;
				}
			  })
			  .on("drag", () => {
				if (subject) {
				  subject[0] = d3.event.x + dx;
				  subject[1] = d3.event.y + dy;
				}
			  })
			  .on("end", () => {
				d3.select(chart).style("cursor", "grab");
			  })
			  .on("start.render drag.render end.render", () =>
				update(chart, points, labels, lines, draw)
			  )
		  );
	}
      </script>
   </body>
</html>